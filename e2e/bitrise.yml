format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  # Shared test configs
  - BITRISE_KEYCHAIN_PATH: $HOME/Library/Keychains/login.keychain
  # Shared test secrets
  - BITRISE_KEYCHAIN_PASSWORD: $BITRISE_KEYCHAIN_PASSWORD
  - BITFALL_APPLE_APPLE_CERTIFICATE_URL_LIST: $BITFALL_APPLE_APPLE_CERTIFICATE_URL_LIST
  - BITFALL_APPLE_IOS_CERTIFICATE_URL_LIST: $BITFALL_APPLE_IOS_CERTIFICATE_URL_LIST
  - BITFALL_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST: $BITFALL_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST
  - BITFALL_APPLE_IOS_CERTIFICATE_PASSPHRASE_LIST: $BITFALL_APPLE_IOS_CERTIFICATE_PASSPHRASE_LIST
  - BITFALL_APPLE_PROVISIONING_PROFILE_URL_LIST: $BITFALL_APPLE_PROVISIONING_PROFILE_URL_LIST

  - BITFALL_APPSTORECONNECT_API_KEY_URL: $BITFALL_APPSTORECONNECT_API_KEY_URL
  - BITFALL_APPSTORECONNECT_API_KEY_ISSUER_ID: $BITFALL_APPSTORECONNECT_API_KEY_ISSUER_ID
  # - BITRISE_APPLE_TEAM_ID : $BITRISE_APPLE_TEAM_ID

workflows:
  test_sample:
    steps:
    - bitrise-run:
        run_if: |-
          {{ or (enveq "IS_LATEST_STACK_XCODE" "true") (not .IsCI) }}
        inputs:
        - workflow_id: utility_test_sample
        - bitrise_config_path: ./e2e/bitrise.yml

  utility_test_sample:
    envs:
    # - TEST_APP_URL: https://github.com/bitrise-io/sample-apps-ios-simple-objc.git
    - TEST_APP_URL: https://github.com/bitrise-io/Fruta
    - TEST_APP_BRANCH: master
    - BITRISE_PROJECT_PATH: Fruta.xcodeproj
    - BITRISE_SCHEME: Fruta iOS
    - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
    - IPA_DISTRIBUTION_METHOD: development
    - LOG_FORMATTER: xcodebuild
    steps:
    - certificate-and-profile-installer:
        inputs:
        - certificate_url: $BITFALL_APPLE_APPLE_CERTIFICATE_URL_LIST|$BITFALL_APPLE_IOS_CERTIFICATE_URL_LIST
        - certificate_passphrase: $BITFALL_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST|$BITFALL_APPLE_IOS_CERTIFICATE_PASSPHRASE_LIST
        - provisioning_profile_url:
        - install_defaults: "no"
        - keychain_path: $BITRISE_KEYCHAIN_PATH
        - keychain_password: $BITRISE_KEYCHAIN_PASSWORD
    - script:
        inputs:
        - content: |-
            #!/bin/env bash
            set -ex
            rm -rf ./_tmp
    - git::https://github.com/bitrise-steplib/bitrise-step-simple-git-clone.git@master:
        inputs:
        - repository_url: $TEST_APP_URL
        - branch: $TEST_APP_BRANCH
        - clone_into_dir: ./_tmp
    - path::./:
        inputs:
        - automatic_code_signing: api-key
        - project_path: ./_tmp/$BITRISE_PROJECT_PATH
        - scheme: $BITRISE_SCHEME
        # - xcconfig_content: |
        #     CODE_SIGN_IDENTITY = $FORCE_CODE_SIGN_IDENTITY
        - distribution_method: $IPA_DISTRIBUTION_METHOD
        - log_formatter: xcpretty

  # test_app_clip:
  #   steps:
  #   - bitrise-run:
  #       run_if: |-
  #         {{ enveq "BITRISEIO_STACK_ID" "osx-xcode-12.5.x" }}
  #       inputs:
  #       - workflow_id: utility_test_app_clip
  #       - bitrise_config_path: ./e2e/bitrise.yml

  # test_app_store:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-samples/Application-Loader-Test.git
  #   - TEST_APP_BRANCH: master
  #   - BITRISE_PROJECT_PATH: "./Application Loader Test.xcodeproj"
  #   - BITRISE_SCHEME: Application Loader Test
  #   # - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   # - FORCE_PROV_PROFILE_SPECIFIER: "BitriseBot-Wildcard"
  #   - IPA_EXPORT_METHOD: app-store
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # utility_test_app_clip:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-io/Fruta
  #   - TEST_APP_BRANCH: xcode-12-gm
  #   - TEST_APP_COMMIT: ""
  #   - BITRISE_PROJECT_PATH: Fruta.xcodeproj
  #   - BITRISE_SCHEME: Fruta iOS
  #   - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # test_catalyst:
  #   steps:
  #   - bitrise-run:
  #       run_if: |-
  #         {{ enveq "BITRISEIO_STACK_ID" "osx-xcode-12.5.x" }}
  #       inputs:
  #       - workflow_id: utility_test_catalyst
  #       - bitrise_config_path: ./e2e/bitrise.yml

  # utility_test_catalyst:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-io/CatalystSample.git
  #   - TEST_APP_BRANCH: master
  #   - TEST_APP_COMMIT: ""
  #   - BITRISE_PROJECT_PATH: Catalyst Sample.xcodeproj
  #   - BITRISE_SCHEME: Catalyst Sample
  #   - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # test_cloudkit:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-ios-multi-target.git
  #   - TEST_APP_BRANCH: cloudkit
  #   - TEST_APP_COMMIT: ""
  #   - BITRISE_PROJECT_PATH: code-sign-test.xcodeproj
  #   - BITRISE_SCHEME: code-sign-test-Prod
  #   - FORCE_CODE_SIGN_IDENTITY: ""
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: Production
  #   - LOG_FORMATTER: xcodebuild
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # test_no_app_dsym:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-io/sample-apps-ios-simple-objc.git
  #   - TEST_APP_BRANCH: with-pods
  #   - TEST_APP_COMMIT: ""
  #   - BITRISE_PROJECT_PATH: ios-simple-objc/ios-simple-objc.xcworkspace
  #   - BITRISE_SCHEME: ios-simple-objc
  #   - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   - DSYM_EXPECTED_COUNT: 1  # Only 1 framework dSYM
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # test_objc_artifact_name:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-io/sample-apps-ios-simple-objc.git
  #   - TEST_APP_BRANCH: ""
  #   - TEST_APP_COMMIT: 65cd120bf4459c2881cfe2b731395b4efc53855d
  #   - BITRISE_PROJECT_PATH: ios-simple-objc/ios-simple-objc.xcodeproj
  #   - BITRISE_SCHEME: ios-simple-objc
  #   - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   - DSYM_EXPECTED_COUNT: 3
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts
  #   - _check_archive_zip

  # test_xcode_8:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-samples/ios-xcode-8.0.git
  #   - TEST_APP_BRANCH: swift_version
  #   - TEST_APP_COMMIT: ""
  #   - BITRISE_PROJECT_PATH: ios-xcode-8.0/ios-xcode-8.0.xcodeproj
  #   - BITRISE_SCHEME: ios-xcode-8.0
  #   - FORCE_CODE_SIGN_IDENTITY: ""
  #   - TEAM_ID: ""
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcpretty
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # test_multi_target:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-ios-multi-target.git
  #   - TEST_APP_BRANCH: ""
  #   - TEST_APP_COMMIT: ab36ed563bbc3125118e9f27df91474822dc0d46
  #   - BITRISE_PROJECT_PATH: code-sign-test.xcodeproj
  #   - BITRISE_SCHEME: code-sign-test
  #   - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: ""
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # test_workspace:
  #   envs:
  #   - TEST_APP_URL: https://github.com/bitrise-samples/sample-apps-ios-workspace-swift.git
  #   - TEST_APP_BRANCH: ""
  #   - TEST_APP_COMMIT: 1360413258cc7f6a8676c17f060ff39899fc28b1
  #   - BITRISE_PROJECT_PATH: sample-apps-ios-workspace-swift.xcworkspace
  #   - BITRISE_SCHEME: sample-apps-ios-workspace-swift
  #   - FORCE_CODE_SIGN_IDENTITY: "iPhone Developer: Dev Portal Bot Bitrise"
  #   - TEAM_ID: 72SA8V3WYL
  #   - FORCE_PROV_PROFILE_SPECIFIER: BitriseBot-Wildcard
  #   - IPA_EXPORT_METHOD: development
  #   - IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT: ""
  #   - LOG_FORMATTER: xcodebuild
  #   after_run:
  #   - _run
  #   - _check_outputs
  #   - _check_exported_artifacts

  # _run:
  #   steps:
  #   - script:
  #       inputs:
  #       - content: |-
  #           #!/bin/bash
  #           set -ex
  #           rm -rf "./_tmp"
  #           mkdir -p "./_tmp"
  #   - git::https://github.com/bitrise-steplib/bitrise-step-simple-git-clone.git:
  #       inputs:
  #       - repository_url: $TEST_APP_URL
  #       - branch: $TEST_APP_BRANCH
  #       - commit: $TEST_APP_COMMIT
  #       - clone_into_dir: ./_tmp
  #   - certificate-and-profile-installer:
  #       inputs:
  #       - certificate_url: $BITFALL_APPLE_APPLE_CERTIFICATE_URL_LIST|$BITFALL_APPLE_IOS_CERTIFICATE_URL_LIST
  #       - certificate_passphrase: $BITFALL_APPLE_APPLE_CERTIFICATE_PASSPHRASE_LIST|$BITFALL_APPLE_IOS_CERTIFICATE_PASSPHRASE_LIST
  #       - provisioning_profile_url: $BITFALL_APPLE_PROVISIONING_PROFILE_URL_LIST
  #       - install_defaults: "no"
  #       - keychain_path: $BITRISE_KEYCHAIN_PATH
  #       - keychain_password: $BITRISE_KEYCHAIN_PASSWORD
  #   - script:
  #       title: Construct xcconfig contents
  #       inputs:
  #       - content: |
  #           CONFIG="COMPILER_INDEX_STORE_ENABLE = NO"

  #           if [ "$FORCE_CODE_SIGN_IDENTITY" != "" ]; then
  #             CONFIG="$CONFIG
  #           CODE_SIGN_IDENTITY = $FORCE_CODE_SIGN_IDENTITY"
  #           fi

  #           if [ "$FORCE_PROV_PROFILE_SPECIFIER" != "" ]; then
  #             CONFIG="$CONFIG
  #           PROVISIONING_PROFILE_SPECIFIER = $FORCE_PROV_PROFILE_SPECIFIER"
  #           fi

  #           printf "xcconfig contents:\n"
  #           printf "$CONFIG"

  #           envman add --key XCCONFIG_CONTENT --value "$CONFIG"
  #   - path::./:
  #       title: Execute step
  #       inputs:
  #       - project_path: ./_tmp/$BITRISE_PROJECT_PATH
  #       - scheme: $BITRISE_SCHEME
  #       - xcconfig_content: $XCCONFIG_CONTENT
  #       - distribution_method: $IPA_EXPORT_METHOD
  #       - icloud_container_environment: $IPA_EXPORT_ICLOUD_CONTAINER_ENVIRONMENT
  #       - export_development_team: $TEAM_ID
  #       - log_formatter: $LOG_FORMATTER
  #       - verbose_log: "yes"

  _check_outputs:
    steps:
    - git::https://github.com/bitrise-steplib/bitrise-step-check-step-outputs.git@main:
        is_always_run: true
        inputs:
        - envs:
        - files:
        - dirs: |-
            BITRISE_APP_DIR_PATH
            BITRISE_DSYM_DIR_PATH
            BITRISE_XCARCHIVE_PATH
        - deploy_dir: $BITRISE_DEPLOY_DIR
        - deployed_files: |-
            BITRISE_IPA_PATH
            BITRISE_DSYM_PATH
            BITRISE_XCARCHIVE_ZIP_PATH
            BITRISE_XCODEBUILD_ARCHIVE_LOG_PATH
            BITRISE_XCODEBUILD_EXPORT_ARCHIVE_LOG_PATH
        - deployed_dirs:

  _check_exported_artifacts:
    steps:
    - script:
        title: Validate exported artifacts
        is_always_run: true
        inputs:
        - content: |-
            #!/usr/bin/env bash

            cd $BITRISE_DSYM_DIR_PATH

            if [ $(find . -name '*.dSYM' -maxdepth 1| wc -l) -eq 0 ]; then
                echo "error, there are no files in the exported dSYM path!"
                ls -la
                exit 1
            fi

            if [ $(find . -maxdepth 1 ! -path . | wc -l) -gt $(find . -name '*.dSYM' -maxdepth 1 | wc -l) ]; then
                echo "error, there are non-dSYM files in the exported dSYM path!"
                ls -la
                exit 1
            fi
    - script:
        title: Check if all dSYMs are exported
        run_if: |-
          {{ getenv "DSYM_EXPECTED_COUNT" | ne "" }}
        inputs:
        - content: |-
            #!/usr/bin/env bash
            set -ex

            cd $BITRISE_DSYM_DIR_PATH

            if [ $(find . -name '*.dSYM' -maxdepth 1 | wc -l) -ne $DSYM_EXPECTED_COUNT ]; then
              echo "error, expected dSYM count ($DSYM_EXPECTED_COUNT) doesn\'t match folder contents: "
              ls -la
              exit 1
            fi

  _check_archive_zip:
    steps:
    - script:
        inputs:
        - content: |-
            set -ex

            /usr/bin/unzip $BITRISE_XCARCHIVE_ZIP_PATH -d ./_tmp

            archive_path="./_tmp/ios-simple-objcTests.xcarchive"
            infoplist_path="$archive_path/Info.plist"
            if [[ ! -f "$infoplist_path" ]]; then
              echo "$infoplist_path does not exist."
              exit 1
            fi
